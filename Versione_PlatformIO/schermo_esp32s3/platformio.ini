[env:esp32-s3-devkitc-1]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

; ========================================
; FLASH CONFIGURATION (Match Arduino IDE)
; ========================================
board_build.flash_mode = qio          ; QIO come Arduino IDE (NON dio!)
board_build.f_flash = 80000000L       ; 80MHz
board_upload.flash_size = 4MB
board_build.partitions = default.csv

; ========================================
; PSRAM CONFIGURATION - CRITICO!
; ========================================
; Il tuo chip ha "Embedded PSRAM 2MB (AP_3v3)" = QUAD mode
; NON usare qio_opi (Octal), usa qio_qspi (Quad)
board_build.arduino.memory_type = qio_qspi

; ========================================
; BUILD FLAGS
; ========================================
build_flags =
    ; === PSRAM Abilitazione ===
    -DBOARD_HAS_PSRAM
    -DARDUINO_ESP32S3_DEV
    
    ; === USB CDC COMPLETAMENTE DISABILITATO ===
    ; Replica "USB CDC On Boot: Disabled" di Arduino IDE
    -DARDUINO_USB_CDC_ON_BOOT=0
    -DARDUINO_USB_MODE=1              ; Hardware CDC and JTAG
    -UARDUINO_USB_CDC_ON_BOOT         ; Rimuovi eventuali definizioni precedenti
    
    ; === Hardware Serial Fix ===
    -DARDUINO_SERIAL_PORT=0           ; Usa UART0 hardware (non CDC)
    
    ; === Core Affinity (opzionale ma raccomandato) ===
    -DARDUINO_RUNNING_CORE=1          ; Loop() su Core 1
    -DARDUINO_EVENT_RUNNING_CORE=1    ; WiFi/BT su Core 1
    
    ; === TFT_eSPI Configuration ===
    -DUSER_SETUP_LOADED=1
    -DST7796_DRIVER=1
    
    ; Pin SPI
    -DTFT_MISO=13
    -DTFT_MOSI=11
    -DTFT_SCLK=12
    -DTFT_CS=10
    -DTFT_DC=9
    -DTFT_RST=-1
    -DTFT_BL=15
    
    ; Touch
    -DTOUCH_CS=17
    
    ; SPI Frequencies (Inizia conservativo)
    -DSPI_FREQUENCY=27000000          ; 27MHz pi√π stabile di 40MHz
    -DSPI_READ_FREQUENCY=16000000
    
    ; Font Loading
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1

; ========================================
; UPLOAD & MONITOR SETTINGS
; ========================================
upload_speed = 921600
monitor_speed = 115200

; Fix per ESP32-S3: Disabilita DTR/RTS durante monitoring
monitor_rts = 0
monitor_dtr = 0

; Decoder per crash analysis
monitor_filters = 
    esp32_exception_decoder
    colorize
    time

; ========================================
; LIBRARIES
; ========================================
lib_deps = 
    bodmer/TFT_eSPI@^2.5.43

; ========================================
; DEBUG (Opzionale - Decommentare se serve)
; ========================================
; build_type = debug
; debug_tool = esp-builtin
; debug_speed = 12000